---
import '@/styles/global.css';

interface NavItem {
  id: string;
  label: string;
  href: string;
  icon: string;
  parent?: string;
}

interface Props {
  title: string;
  description?: string;
  section?: string;
  subsection?: string;
}

const { title, description, section, subsection } = Astro.props;
const fullTitle = `${title} â€” XergioAleX Internal`;

const navItems: NavItem[] = [
  { id: 'hub', label: 'Hub', href: '/internal', icon: '~' },
  { id: 'ui', label: 'UI Design System', href: '/internal/ui', icon: '#' },
  { id: 'guide', label: 'Staff Guide', href: '/internal/guide', icon: '>' },
  {
    id: 'tech-stack',
    label: 'Tech Stack',
    href: '/internal/guide/tech-stack',
    icon: '*',
    parent: 'guide',
  },
  {
    id: 'file-structure',
    label: 'File Structure',
    href: '/internal/guide/file-structure',
    icon: '/',
    parent: 'guide',
  },
  { id: 'sitemap', label: 'Sitemap', href: '/internal/sitemap', icon: '@' },
];

const activeId = subsection || section;
const isGuideActive =
  section === 'guide' ||
  navItems.some((item) => item.parent === 'guide' && item.id === activeId);

const topLevelItems = navItems.filter((item) => !item.parent);
const guideChildren = navItems.filter((item) => item.parent === 'guide');

const visibleItems = navItems.filter((item) => !item.parent || isGuideActive);
const currentIndex = visibleItems.findIndex((item) => item.id === activeId);
const prevItem = currentIndex > 0 ? visibleItems[currentIndex - 1] : null;
const nextItem =
  currentIndex < visibleItems.length - 1
    ? visibleItems[currentIndex + 1]
    : null;
---

<html lang="en" data-internal="true">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{fullTitle}</title>
    {description && <meta name="description" content={description} />}
    <script is:inline>
  (function(){var t=localStorage.getItem('theme');if(t==='dark')document.documentElement.classList.add('dark');else{document.documentElement.classList.remove('dark');localStorage.setItem('theme','light');}})();
</script>
  </head>
  <body class="min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans antialiased transition-colors duration-300">

    <!-- Sticky amber warning banner -->
    <div class="sticky top-0 z-50 flex items-center justify-between px-3 sm:px-4 py-2 text-sm font-semibold bg-amber-100 dark:bg-amber-900/60 text-amber-900 dark:text-amber-100 border-b border-amber-300 dark:border-amber-700">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center rounded-full bg-amber-500 px-2 py-0.5 text-xs font-bold text-white uppercase tracking-wide">
          INTERNAL
        </span>
        <span class="text-xs sm:text-sm">Staff Documentation Portal</span>
      </div>
      <span class="hidden md:inline text-xs text-amber-700 dark:text-amber-300">
        Not included in production
      </span>
    </div>

    <!-- Mobile horizontal navigation -->
    <div class="lg:hidden sticky top-[41px] z-40 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-1 px-2 py-2 overflow-x-auto scrollbar-hide">
        {visibleItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-colors whitespace-nowrap',
              item.parent ? 'ml-1' : '',
              activeId === item.id
                ? 'bg-gray-900 text-white dark:bg-white dark:text-gray-900'
                : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700',
            ]}
            aria-current={activeId === item.id ? 'page' : undefined}
          >
            <span class="text-sm font-mono" aria-hidden="true">{item.icon}</span>
            <span>{item.label}</span>
          </a>
        ))}
      </div>
    </div>

    <div class="flex min-h-[calc(100vh-40px)]">

      <!-- Desktop sidebar -->
      <nav
        class="hidden lg:flex flex-col w-60 shrink-0 border-r border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 sticky top-[41px] h-[calc(100vh-41px)]"
      >
        <div class="flex-1 overflow-y-auto py-4 px-3">
          <div class="mb-4 px-2">
            <span class="text-xs font-bold uppercase tracking-wider text-gray-400 dark:text-gray-500">
              Navigation
            </span>
          </div>
          <ul class="space-y-0.5">
            {topLevelItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  class:list={[
                    'flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors',
                    activeId === item.id || (item.id === 'guide' && isGuideActive)
                      ? 'bg-gray-900 text-white dark:bg-white dark:text-gray-900'
                      : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700',
                  ]}
                  aria-current={activeId === item.id ? 'page' : undefined}
                >
                  <span class="w-6 text-center text-base font-mono" aria-hidden="true">{item.icon}</span>
                  <span>{item.label}</span>
                </a>
                {item.id === 'guide' && isGuideActive && (
                  <ul class="mt-0.5 ml-6 space-y-0.5">
                    {guideChildren.map((child) => (
                      <li>
                        <a
                          href={child.href}
                          class:list={[
                            'flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors',
                            activeId === child.id
                              ? 'bg-gray-800 text-white dark:bg-gray-200 dark:text-gray-900'
                              : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700',
                          ]}
                          aria-current={activeId === child.id ? 'page' : undefined}
                        >
                          <span class="font-mono" aria-hidden="true">{child.icon}</span>
                          <span>{child.label}</span>
                        </a>
                      </li>
                    ))}
                  </ul>
                )}
              </li>
            ))}
          </ul>
        </div>
      </nav>

      <!-- Main content area -->
      <main class="flex-1 min-w-0 overflow-x-hidden">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
          <div class="mb-8 sm:mb-10">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight">{title}</h1>
            {description && (
              <p class="mt-2 text-base sm:text-lg text-gray-600 dark:text-gray-300">{description}</p>
            )}
          </div>

          <slot />

          <!-- Mobile prev/next navigation -->
          <div class="lg:hidden flex items-center justify-between mt-12 pt-6 border-t border-gray-200 dark:border-gray-700">
            {prevItem ? (
              <a href={prevItem.href} class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                <span aria-hidden="true">&larr;</span>
                <span>{prevItem.label}</span>
              </a>
            ) : <span />}
            {nextItem && (
              <a href={nextItem.href} class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                <span>{nextItem.label}</span>
                <span aria-hidden="true">&rarr;</span>
              </a>
            )}
          </div>
        </div>

        <footer class="border-t border-gray-200 dark:border-gray-700 px-4 sm:px-6 py-4 text-center text-xs text-gray-600 dark:text-gray-300">
          XergioAleX Internal Hub &middot; Staff Only &middot; Dev Only
        </footer>
      </main>
    </div>

    <script is:inline>
      (function () {
        var active = document.querySelector('[aria-current="page"]');
        if (active) {
          var nav = active.closest('.scrollbar-hide');
          if (nav) {
            var offset = active.offsetLeft - nav.offsetWidth / 2 + active.offsetWidth / 2;
            nav.scrollLeft = Math.max(0, offset);
          }
        }
      })();
    </script>

    <style>
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
  </body>
</html>
