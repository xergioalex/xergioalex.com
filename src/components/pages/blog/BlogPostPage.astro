---
import type { CollectionEntry } from 'astro:content';
import { render } from 'astro:content';
import BlogPostHeader from '@/components/blog/BlogPostHeader.astro';
import RelatedArticles from '@/components/blog/RelatedArticles.astro';
import JsonLd from '@/components/JsonLd.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import {
  getPostStatus,
  getReadingTimeFromContent,
  getRelatedPosts,
  getWordCount,
  isDemoPost,
} from '@/lib/blog';
import type { Language } from '@/lib/i18n';
import { getUrlPrefix } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';

interface Props {
  lang: Language;
  post: CollectionEntry<'blog'>;
}

const { lang, post } = Astro.props;
const t = getTranslations(lang);
const prefix = getUrlPrefix(lang);

const { heroImage, pubDate, updatedDate, title, description, tags } = post.data;
const { Content } = await render(post);
const readingTimeMinutes = getReadingTimeFromContent(post.body ?? '');
const wordCount = getWordCount(post.body ?? '');
const postStatus = getPostStatus(post);
const isDemo = isDemoPost(post);
const isDev = import.meta.env.DEV;
const hasScheduledTime = pubDate.getHours() !== 0 || pubDate.getMinutes() !== 0;
const relatedPosts = await getRelatedPosts({
  currentPostId: post.id,
  tags: tags ?? [],
  lang,
  limit: 3,
});

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const articleSection = tags?.[0] ? t.tagNames[tags[0]] || tags[0] : 'Blog';
const blogPostingData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: heroImage ? new URL(heroImage, Astro.site).href : undefined,
  datePublished: pubDate.toISOString(),
  dateModified: updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  publisher: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL.href,
  },
  keywords: tags || [],
  wordCount,
  timeRequired: `PT${readingTimeMinutes}M`,
  inLanguage: lang,
  articleSection,
  url: canonicalURL.href,
};

const homeUrl = prefix || '/';
const blogUrl = `${prefix}/blog/`;

const breadcrumbData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: t.nav.home,
      item: new URL(homeUrl, Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: t.nav.blog,
      item: new URL(blogUrl, Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: canonicalURL.href,
    },
  ],
};
---

<MainLayout lang={lang} title={title} description={description}>
  <Fragment slot="head">
    <JsonLd data={blogPostingData} />
    <JsonLd data={breadcrumbData} />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={pubDate.toISOString()} />
    <meta property="article:modified_time" content={(updatedDate ?? pubDate).toISOString()} />
    <meta property="article:author" content={new URL('/about/', Astro.site).href} />
    <meta property="article:section" content={articleSection} />
    {tags?.map((tag) => <meta property="article:tag" content={tag} />)}
  </Fragment>
  <main class="main-container py-16 md:py-24">
    <article>
      {isDev && (postStatus !== 'published' || isDemo) && (
        <div class="mb-4 flex flex-wrap gap-2">
          {isDemo && (
            <div class="p-3 rounded-lg border-2 text-sm font-medium bg-purple-50 border-purple-300 text-purple-800 dark:bg-purple-900/20 dark:border-purple-700 dark:text-purple-300">
              {t.postStatus.demo}
            </div>
          )}
          {postStatus !== 'published' && (
            <div class={`p-3 rounded-lg border-2 text-sm font-medium ${
              postStatus.includes('draft')
                ? 'bg-amber-50 border-amber-300 text-amber-800 dark:bg-amber-900/20 dark:border-amber-700 dark:text-amber-300'
                : 'bg-blue-50 border-blue-300 text-blue-800 dark:bg-blue-900/20 dark:border-blue-700 dark:text-blue-300'
            }`}>
              {postStatus === 'draft+scheduled' ? t.postStatus.draft : t.postStatus[postStatus]}
              {postStatus.includes('scheduled') && (
                <span class="ml-1 opacity-75">
                  — {t.publishesOn} {pubDate.toLocaleDateString(t.dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}{hasScheduledTime ? `, ${pubDate.toLocaleTimeString(t.dateLocale, { hour: '2-digit', minute: '2-digit' })}` : ''}
                </span>
              )}
            </div>
          )}
          {postStatus === 'draft+scheduled' && (
            <div class="p-3 rounded-lg border-2 text-sm font-medium bg-blue-50 border-blue-300 text-blue-800 dark:bg-blue-900/20 dark:border-blue-700 dark:text-blue-300">
              {t.postStatus.scheduled}
              <span class="ml-1 opacity-75">
                — {t.publishesOn} {pubDate.toLocaleDateString(t.dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}{hasScheduledTime ? `, ${pubDate.toLocaleTimeString(t.dateLocale, { hour: '2-digit', minute: '2-digit' })}` : ''}
              </span>
            </div>
          )}
        </div>
      )}
      <nav aria-label="Breadcrumb" class="mb-6 flex flex-wrap items-center gap-x-2 text-sm">
        <a href={homeUrl} class="font-semibold text-gray-600 transition-colors hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400">{t.nav.home}</a>
        <span class="font-semibold text-gray-600 dark:text-gray-300 select-none" aria-hidden="true">/</span>
        <a href={blogUrl} class="font-semibold text-gray-600 transition-colors hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400">{t.nav.blog}</a>
        <span class="font-semibold text-gray-600 dark:text-gray-300 select-none" aria-hidden="true">/</span>
        <span class="truncate font-normal text-gray-600 dark:text-gray-300" aria-current="page">{title}</span>
      </nav>
      <BlogPostHeader
        title={title}
        pubDate={pubDate}
        updatedDate={updatedDate}
        heroImage={heroImage}
        heroLayout={post.data.heroLayout}
        tags={tags}
        lang={lang}
        readingTimeMinutes={readingTimeMinutes}
      />
      <div class="prose prose-lg prose-slate mx-auto max-w-4xl dark:prose-invert prose-headings:scroll-mt-24 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-img:block prose-img:mx-auto">
        <Content />
      </div>
      <RelatedArticles posts={relatedPosts} lang={lang} />
    </article>
  </main>
</MainLayout>
