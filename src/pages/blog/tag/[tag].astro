---
import { getCollection } from 'astro:content';
import BlogTagPage from '@/components/pages/blog/BlogTagPage.astro';
import { getBlogPosts, isPostVisibleInProduction } from '@/lib/blog';
import { isPreviewFeaturesEnabled } from '@/lib/env';
import type { Language } from '@/lib/i18n';

const lang: Language = 'en';

export async function getStaticPaths() {
  const lang: Language = 'en';
  const includeHidden = isPreviewFeaturesEnabled();

  const allPosts = await getCollection('blog');
  const visiblePosts = allPosts.filter((post) => {
    if (!post.id.startsWith(`${lang}/`)) return false;
    if (import.meta.env.PROD && !includeHidden)
      return isPostVisibleInProduction(post);
    return true;
  });
  const tagsResult = Array.from(
    new Set(visiblePosts.flatMap((post) => post.data.tags ?? []))
  );

  const paths = [];
  for (const tag of tagsResult) {
    const tagPostsResult = await getBlogPosts({
      lang,
      tag,
      includeHidden,
    });
    paths.push({
      params: { tag },
      props: { blogPostsResult: tagPostsResult, currentTag: tag },
    });
  }
  return paths;
}

const { blogPostsResult, currentTag } = Astro.props;
const { tag } = Astro.params;
---

<BlogTagPage lang={lang} blogPostsResult={blogPostsResult} currentTag={currentTag} tag={tag} />
