---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPostHeader from '@/components/blog/BlogPostHeader.astro';
import RelatedArticles from '@/components/blog/RelatedArticles.astro';
import JsonLd from '@/components/JsonLd.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import {
  getReadingTimeFromContent,
  getRelatedPosts,
  getWordCount,
} from '@/lib/blog';
import { getTranslations, type Language } from '@/lib/translations';

const lang: Language = 'en';
const t = getTranslations(lang);

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  // Only English posts (in en/ folder)
  const posts = allPosts.filter((post) => post.id.startsWith('en/'));
  return posts.map((post) => ({
    // Remove language prefix from URL: "en/first-post" -> "first-post"
    params: { slug: post.id.replace('en/', '') },
    props: post,
  }));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { heroImage, pubDate, updatedDate, title, description, tags } = post.data;
const { Content } = await render(post);
const readingTimeMinutes = getReadingTimeFromContent(post.body ?? '');
const wordCount = getWordCount(post.body ?? '');
const relatedPosts = await getRelatedPosts({
  currentPostId: post.id,
  tags: tags ?? [],
  lang,
  limit: 3,
});

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const articleSection = tags?.[0] ? t.tagNames[tags[0]] || tags[0] : 'Blog';
const blogPostingData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: heroImage ? new URL(heroImage, Astro.site).href : undefined,
  datePublished: pubDate.toISOString(),
  dateModified: updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  publisher: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL.href,
  },
  keywords: tags || [],
  wordCount,
  timeRequired: `PT${readingTimeMinutes}M`,
  inLanguage: 'en',
  articleSection,
  url: canonicalURL.href,
};

const breadcrumbData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: t.nav.home,
      item: new URL('/', Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: t.nav.blog,
      item: new URL('/blog/', Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: canonicalURL.href,
    },
  ],
};
---

<MainLayout lang={lang} title={title} description={description}>
  <Fragment slot="head">
    <JsonLd data={blogPostingData} />
    <JsonLd data={breadcrumbData} />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={pubDate.toISOString()} />
    <meta property="article:modified_time" content={(updatedDate ?? pubDate).toISOString()} />
    <meta property="article:author" content={new URL('/about/', Astro.site).href} />
    <meta property="article:section" content={articleSection} />
    {tags?.map((tag) => <meta property="article:tag" content={tag} />)}
  </Fragment>
  <main class="main-container py-16 md:py-24">
    <article>
      <nav aria-label="Breadcrumb" class="mb-6 text-sm text-[rgb(var(--gray))]">
        <a href="/" class="transition-colors hover:text-blue-600 dark:hover:text-blue-400">{t.nav.home}</a>
        <span class="mx-2">/</span>
        <a href="/blog/" class="transition-colors hover:text-blue-600 dark:hover:text-blue-400">{t.nav.blog}</a>
        <span class="mx-2">/</span>
        <span class="truncate text-[rgb(var(--gray-dark))] dark:text-gray-300">{title}</span>
      </nav>
      <BlogPostHeader
        title={title}
        pubDate={pubDate}
        updatedDate={updatedDate}
        heroImage={heroImage}
        heroLayout={post.data.heroLayout}
        tags={tags}
        lang={lang}
        readingTimeMinutes={readingTimeMinutes}
      />
      <div class="prose prose-lg prose-slate mx-auto max-w-4xl dark:prose-invert prose-headings:scroll-mt-24 prose-a:text-blue-600 dark:prose-a:text-blue-400">
        <Content />
      </div>
      <RelatedArticles posts={relatedPosts} lang={lang} />
    </article>
  </main>
</MainLayout>
