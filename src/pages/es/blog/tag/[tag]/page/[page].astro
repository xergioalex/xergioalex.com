---
import { getCollection } from 'astro:content';
import BlogTagPaginationPage from '@/components/pages/blog/BlogTagPaginationPage.astro';
import { getBlogPosts, isPostVisibleInProduction } from '@/lib/blog';
import { isPreviewFeaturesEnabled } from '@/lib/env';
import type { Language } from '@/lib/i18n';

const lang: Language = 'es';

export async function getStaticPaths() {
  const lang: Language = 'es';
  const includeHidden = isPreviewFeaturesEnabled();

  const allPosts = await getCollection('blog');
  const visiblePosts = allPosts.filter((post) => {
    if (!post.id.startsWith(`${lang}/`)) return false;
    if (import.meta.env.PROD && !includeHidden)
      return isPostVisibleInProduction(post);
    return true;
  });
  const tagsResult = Array.from(
    new Set(visiblePosts.flatMap((post) => post.data.tags ?? []))
  );

  const paths = [];
  for (const tag of tagsResult) {
    const tagPostsResult = await getBlogPosts({
      lang,
      tag,
      includeHidden,
    });
    const totalPages = tagPostsResult.totalPages;

    if (totalPages > 1) {
      for (let i = 2; i <= totalPages; i++) {
        const pagePosts = await getBlogPosts({
          lang,
          tag,
          page: i,
          includeHidden,
        });
        paths.push({
          params: { tag, page: String(i) },
          props: { blogPostsResult: pagePosts, currentTag: tag },
        });
      }
    }
  }
  return paths;
}

const { blogPostsResult, currentTag } = Astro.props;
const { tag, page } = Astro.params;
---

<BlogTagPaginationPage lang={lang} blogPostsResult={blogPostsResult} currentTag={currentTag} tag={tag} page={page} />
