---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPostHeader from '@/components/blog/BlogPostHeader.astro';
import RelatedArticles from '@/components/blog/RelatedArticles.astro';
import JsonLd from '@/components/JsonLd.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import {
  getPostSlug,
  getPostStatus,
  getReadingTimeFromContent,
  getRelatedPosts,
  getWordCount,
  isDemoPost,
  isPostVisibleInProduction,
} from '@/lib/blog';
import { getTranslations, type Language } from '@/lib/translations';

const lang: Language = 'es';
const t = getTranslations(lang);

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  // Only Spanish posts (in es/ folder)
  // In production, only generate pages for published posts
  // In dev, generate pages for ALL posts (so they're accessible by URL)
  const posts = allPosts.filter((post) => {
    if (!post.id.startsWith('es/')) return false;
    if (import.meta.env.PROD) return isPostVisibleInProduction(post);
    return true;
  });
  return posts.map((post) => ({
    // Remove language prefix and date prefix from URL
    params: { slug: getPostSlug(post.id) },
    props: post,
  }));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { heroImage, pubDate, updatedDate, title, description, tags } = post.data;
const { Content } = await render(post);
const readingTimeMinutes = getReadingTimeFromContent(post.body ?? '');
const wordCount = getWordCount(post.body ?? '');
const postStatus = getPostStatus(post);
const isDemo = isDemoPost(post);
const isDev = import.meta.env.DEV;
const hasScheduledTime = pubDate.getHours() !== 0 || pubDate.getMinutes() !== 0;
const relatedPosts = await getRelatedPosts({
  currentPostId: post.id,
  tags: tags ?? [],
  lang,
  limit: 3,
});

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const articleSection = tags?.[0] ? t.tagNames[tags[0]] || tags[0] : 'Blog';
const blogPostingData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: heroImage ? new URL(heroImage, Astro.site).href : undefined,
  datePublished: pubDate.toISOString(),
  dateModified: updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  publisher: {
    '@type': 'Person',
    name: 'Sergio Alexander Florez Galeano',
    url: new URL('/about/', Astro.site).href,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL.href,
  },
  keywords: tags || [],
  wordCount,
  timeRequired: `PT${readingTimeMinutes}M`,
  inLanguage: 'es',
  articleSection,
  url: canonicalURL.href,
};

const breadcrumbData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: t.nav.home,
      item: new URL('/es/', Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: t.nav.blog,
      item: new URL('/es/blog/', Astro.site).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: canonicalURL.href,
    },
  ],
};
---

<MainLayout lang={lang} title={title} description={description}>
  <Fragment slot="head">
    <JsonLd data={blogPostingData} />
    <JsonLd data={breadcrumbData} />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={pubDate.toISOString()} />
    <meta property="article:modified_time" content={(updatedDate ?? pubDate).toISOString()} />
    <meta property="article:author" content={new URL('/about/', Astro.site).href} />
    <meta property="article:section" content={articleSection} />
    {tags?.map((tag) => <meta property="article:tag" content={tag} />)}
  </Fragment>
  <main class="main-container py-16 md:py-24">
    <article>
      {isDev && (postStatus !== 'published' || isDemo) && (
        <div class="mb-4 flex flex-wrap gap-2">
          {isDemo && (
            <div class="p-3 rounded-lg border-2 text-sm font-medium bg-purple-50 border-purple-300 text-purple-800 dark:bg-purple-900/20 dark:border-purple-700 dark:text-purple-300">
              {t.postStatus.demo}
            </div>
          )}
          {postStatus !== 'published' && (
            <div class={`p-3 rounded-lg border-2 text-sm font-medium ${
              postStatus.includes('draft')
                ? 'bg-amber-50 border-amber-300 text-amber-800 dark:bg-amber-900/20 dark:border-amber-700 dark:text-amber-300'
                : 'bg-blue-50 border-blue-300 text-blue-800 dark:bg-blue-900/20 dark:border-blue-700 dark:text-blue-300'
            }`}>
              {postStatus === 'draft+scheduled' ? t.postStatus.draft : t.postStatus[postStatus]}
              {postStatus.includes('scheduled') && (
                <span class="ml-1 opacity-75">
                  — {t.publishesOn} {pubDate.toLocaleDateString(t.dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}{hasScheduledTime ? `, ${pubDate.toLocaleTimeString(t.dateLocale, { hour: '2-digit', minute: '2-digit' })}` : ''}
                </span>
              )}
            </div>
          )}
          {postStatus === 'draft+scheduled' && (
            <div class="p-3 rounded-lg border-2 text-sm font-medium bg-blue-50 border-blue-300 text-blue-800 dark:bg-blue-900/20 dark:border-blue-700 dark:text-blue-300">
              {t.postStatus.scheduled}
              <span class="ml-1 opacity-75">
                — {t.publishesOn} {pubDate.toLocaleDateString(t.dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}{hasScheduledTime ? `, ${pubDate.toLocaleTimeString(t.dateLocale, { hour: '2-digit', minute: '2-digit' })}` : ''}
              </span>
            </div>
          )}
        </div>
      )}
      <nav aria-label="Breadcrumb" class="mb-6 text-sm text-[rgb(var(--gray))]">
        <a href="/es/" class="transition-colors hover:text-blue-600 dark:hover:text-blue-400">{t.nav.home}</a>
        <span class="mx-2">/</span>
        <a href="/es/blog/" class="transition-colors hover:text-blue-600 dark:hover:text-blue-400">{t.nav.blog}</a>
        <span class="mx-2">/</span>
        <span class="truncate text-[rgb(var(--gray-dark))] dark:text-gray-300">{title}</span>
      </nav>
      <BlogPostHeader
        title={title}
        pubDate={pubDate}
        updatedDate={updatedDate}
        heroImage={heroImage}
        heroLayout={post.data.heroLayout}
        tags={tags}
        lang={lang}
        readingTimeMinutes={readingTimeMinutes}
      />
      <div class="prose prose-lg prose-slate mx-auto max-w-4xl dark:prose-invert prose-headings:scroll-mt-24 prose-a:text-blue-600 dark:prose-a:text-blue-400">
        <Content />
      </div>
      <RelatedArticles posts={relatedPosts} lang={lang} />
    </article>
  </main>
</MainLayout>
