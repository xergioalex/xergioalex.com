---
import InternalLayout from '@/layouts/InternalLayout.astro';

const pageSpeedOptimizations = [
  {
    area: 'Image Delivery',
    mitigations: [
      'WebP pipeline: homepage, blog shared, blog post heroes (~1.3 MB savings)',
      'Scripts: generate-webp-homepage.mjs, generate-webp-blog-shared.mjs, generate-webp-blog-posts.mjs',
      'Components: BlogHeroImage, HomeSectionImage, PageHero use <picture> with WebP',
      'Skips regeneration when .webp exists and is newer than source',
    ],
  },
  {
    area: 'Render-Blocking',
    mitigations: [
      'Theme script inlined in MainLayout (no external global.theme.js)',
      "CSS inlined via build.inlineStylesheets: 'always'",
    ],
  },
  {
    area: 'LCP',
    mitigations: [
      'Hero logo: preload + fetchpriority="high" + loading="eager"',
      'Above-fold images use loading="eager"',
    ],
  },
  {
    area: 'Forced Reflow',
    mitigations: [
      'MobileMenu: scroll lock deferred with requestAnimationFrame',
      'MobileMenu: transition:fade instead of transition:slide',
    ],
  },
  {
    area: 'Critical Path',
    mitigations: [
      'TypewriterWords uses CSS-only animation (zero JS, no critical chain)',
      'Below-fold components use client:visible or client:idle',
    ],
  },
];

const pipelineSteps = [
  { step: 'prebuild', desc: 'Runs before npm run build; generates WebP' },
  { step: 'images:webp', desc: 'Manual: npm run images:webp' },
  { step: 'codecheck', desc: 'Docker: fix + images:webp + test' },
  { step: 'code_check', desc: 'CI: astro + biome + test + build' },
];
---

<InternalLayout title="Performance & PageSpeed" description="PageSpeed optimizations and image pipeline" section="guide">
  <section class="mb-12">
    <h2 class="text-xl md:text-2xl font-bold mb-4">PageSpeed Optimizations</h2>
    <p class="text-gray-600 dark:text-gray-300 mb-6">
      These mitigations address Lighthouse diagnostics. See <code class="text-sm bg-gray-100 dark:bg-gray-800 px-1 rounded">docs/PERFORMANCE.md</code> for full details.
    </p>
    <div class="space-y-6">
      {pageSpeedOptimizations.map((item) => (
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 p-4">
          <h3 class="font-semibold mb-2">{item.area}</h3>
          <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-300 space-y-1">
            {item.mitigations.map((m) => (
              <li>{m}</li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  </section>

  <section class="mb-12">
    <h2 class="text-xl md:text-2xl font-bold mb-4">Image WebP Pipeline</h2>
    <p class="text-gray-600 dark:text-gray-300 mb-4">
      WebP generation runs automatically. Scripts skip images that already have a valid .webp (same or newer mtime).
    </p>
    <div class="rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <th class="text-left py-3 px-4 font-semibold">When</th>
            <th class="text-left py-3 px-4 font-semibold">Description</th>
          </tr>
        </thead>
        <tbody>
          {pipelineSteps.map((row) => (
            <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
              <td class="py-3 px-4 font-mono text-xs">{row.step}</td>
              <td class="py-3 px-4 text-gray-600 dark:text-gray-300">{row.desc}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section>
    <h2 class="text-xl md:text-2xl font-bold mb-4">Deployment</h2>
    <p class="text-gray-600 dark:text-gray-300">
      Cloudflare Pages deploys on push to <code class="text-sm bg-gray-100 dark:bg-gray-800 px-1 rounded">main</code>.
      Build command: <code class="text-sm bg-gray-100 dark:bg-gray-800 px-1 rounded">npm run build</code>.
      Output: <code class="text-sm bg-gray-100 dark:bg-gray-800 px-1 rounded">dist/</code>.
    </p>
  </section>
</InternalLayout>
