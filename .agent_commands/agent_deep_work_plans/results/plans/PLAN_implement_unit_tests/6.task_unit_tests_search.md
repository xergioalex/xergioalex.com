# Task 6: Write Unit Tests for search.ts

## 1. Context

**Purpose:** Create unit tests for all exported functions from `src/lib/search.ts`.

**Where:**
- `tests/unit/lib/search.test.ts` — New test file
- `src/lib/search.ts` — Source file being tested

**Exported functions:**

| Function | Signature | Purpose |
|----------|-----------|---------|
| `createSearchIndex` | `(posts: SearchablePost[]): Fuse<SearchablePost>` | Creates a Fuse.js search index from posts |
| `searchPosts` | `(fuse: Fuse, query: string, limit?: number): SearchResult[]` | Searches posts using the Fuse index |
| `highlightMatches` | `(text: string, indices: ReadonlyArray<readonly [number, number]>): string` | Wraps matched text segments in `<mark>` tags |
| `getHighlightedField` | `(result: SearchResult, fieldName: string, originalValue: string): string` | Extracts highlighted version of a specific field from search result |

**Private function (tested indirectly via `highlightMatches`):**
- `escapeHtml(text: string): string` — Escapes `&`, `<`, `>`, `"`, `'` to prevent XSS

**Types:**
```typescript
interface SearchablePost {
  id: string; slug: string; lang: string; title: string;
  description: string; tags: string[]; pubDate: string; heroImage?: string;
}
interface SearchResult {
  item: SearchablePost; score: number;
  matches?: ReadonlyArray<{ key?: string; value?: string; indices: ReadonlyArray<readonly [number, number]> }>;
}
```

**Dependencies:** Tasks 1-3 must be completed.

## 2. Read Before Starting

- Task 3 Completion & Log: Verify fixtures are available
- Read `src/lib/search.ts` fully to understand Fuse.js options and highlighting logic

## 3. Goal

Write comprehensive unit tests for all 4 exported functions in `src/lib/search.ts` targeting 85%+ coverage. Test both the Fuse.js integration (with real Fuse instances) and the highlighting utilities.

## 4. Instructions

> **Before starting:** Re-read the plan README section 1 (Goal) to ensure this task's work aligns with the overall objective.

### Step 1: Read the source file

Read `src/lib/search.ts` completely. Pay attention to:
- Fuse.js options (keys, weights, threshold)
- How `escapeHtml` is used inside `highlightMatches`
- How `getHighlightedField` looks up matches by field name
- Edge cases in highlighting (overlapping indices, empty indices)

### Step 2: Create `tests/unit/lib/search.test.ts`

Write tests organized by function:

#### `highlightMatches`
- Highlights a single match: `highlightMatches('hello world', [[0, 4]])` → `<mark>hello</mark> world`
- Highlights multiple non-overlapping matches
- Handles empty indices array (returns escaped text)
- Handles HTML special characters in text (tests `escapeHtml` indirectly):
  - `<script>` should be escaped to `&lt;script&gt;`
  - `&` should be escaped to `&amp;`
  - `"` and `'` should be escaped
- Handles match at end of string
- Handles match spanning entire string

#### `getHighlightedField`
- Returns highlighted text when field match exists
- Returns escaped original value when no match for the field
- Returns escaped original value when no matches at all
- Handles `undefined` matches array

#### `createSearchIndex`
- Creates a Fuse instance from an array of SearchablePost objects
- Returned object is an instance of Fuse
- Handles empty array (returns valid Fuse instance)

#### `searchPosts`
- Returns matching results for a known query
- Respects the `limit` parameter
- Returns empty array for no matches
- Returns empty array for empty query string
- Results have correct shape (item, score)
- Search works across title, description, and tags fields

### Step 3: Create test search data

Create inline SearchablePost mock data for search tests (don't use blog post fixtures — these need a different shape):

```typescript
const searchPosts: SearchablePost[] = [
  { id: '1', slug: 'astro-guide', lang: 'en', title: 'Complete Guide to Astro', description: 'Learn Astro from scratch', tags: ['astro', 'web'], pubDate: '2024-03-15' },
  { id: '2', slug: 'svelte-basics', lang: 'en', title: 'Svelte Basics', description: 'Getting started with Svelte', tags: ['svelte', 'frontend'], pubDate: '2024-03-10' },
  // ... more posts
];
```

### Step 4: Run tests

```bash
npm run test
```

## 5. Acceptance Criteria

- [ ] `tests/unit/lib/search.test.ts` exists with comprehensive tests
- [ ] All 4 exported functions have dedicated `describe` blocks
- [ ] HTML escaping verified (XSS prevention)
- [ ] Fuse.js integration tested with real instances
- [ ] All tests pass (`npm run test`)

## 6. Outputs

- `tests/unit/lib/search.test.ts` — Complete test file for search utilities

## 7. Validation

```bash
# Run tests
npm run test

# Run with coverage
npm run test:coverage

# Verify biome compliance
npm run biome:check
```

## 8. Execution Checklist

- [ ] Read `src/lib/search.ts` completely
- [ ] Create `tests/unit/lib/search.test.ts`
- [ ] Write tests for all 4 exported functions
- [ ] Include XSS/HTML escaping tests
- [ ] Run `npm run test` — all pass
- [ ] Run `npm run biome:check`
- [ ] Update plan README `[ ] → [x]`
- [ ] Update PROGRESS.md
- [ ] Commit changes
- [ ] Update log below

## 9. Completion & Log

**Status:** Completed

- Tests written: 26
- Tests passing: 26/26
- Coverage for search.ts: All exported functions covered, escapeHtml tested indirectly
- Notes: Used real Fuse.js instances for integration-level tests. HTML escaping verified for XSS prevention.
