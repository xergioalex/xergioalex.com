# Task 5: Write Unit Tests for i18n.ts

## 1. Context

**Purpose:** Create comprehensive unit tests for all pure functions exported from `src/lib/i18n.ts`.

**Where:**
- `tests/unit/lib/i18n.test.ts` — New test file
- `src/lib/i18n.ts` — Source file being tested

**Exported functions (all 13 are pure, no side effects):**

| Function | Signature | Purpose |
|----------|-----------|---------|
| `getSupportedLanguages` | `(): Language[]` | Returns array of supported language codes |
| `getLanguageConfig` | `(lang: Language): LanguageConfig` | Returns full config for a language |
| `getDefaultLanguage` | `(): Language` | Returns default language (`'en'`) |
| `isValidLanguage` | `(value: string): value is Language` | Type guard for valid language codes |
| `isDefaultLanguage` | `(lang: Language): boolean` | Checks if language is the default |
| `getUrlPrefix` | `(lang: Language): string` | Returns URL prefix (`''` for en, `'/es'` for es) |
| `getDateLocale` | `(lang: Language): string` | Returns locale string for date formatting |
| `getOGLocale` | `(lang: Language): string` | Returns Open Graph locale string |
| `getFlag` | `(lang: Language): string` | Returns flag emoji for language |
| `getLocalizedUrl` | `(path: string, lang: Language): string` | Builds a localized URL |
| `stripLangPrefix` | `(path: string): string` | Removes language prefix from URL path |
| `getLangFromUrl` | `(pathname: string): Language` | Extracts language from URL path |
| `getAlternateUrls` | `(currentPath: string): {lang, url}[]` | Generates alternate language URLs for SEO |

**Type exports (not testable at runtime):**
- `Language` — `'en' | 'es'`
- `LanguageConfig` — Interface with code, name, nativeName, dateLocale, ogLocale, flag, urlPrefix

**Constants:**
- `DEFAULT_LANGUAGE: Language` — `'en'`
- `LANGUAGES: Record<Language, LanguageConfig>` — Language registry

**Dependencies:** Tasks 1-3 must be completed.

## 2. Read Before Starting

- Task 3 Completion & Log: Verify fixtures are available
- Read `src/lib/i18n.ts` fully to understand all function logic

## 3. Goal

Write comprehensive unit tests for all 13 exported functions in `src/lib/i18n.ts` targeting 95%+ coverage. This is the most important utility file for the i18n system.

## 4. Instructions

> **Before starting:** Re-read the plan README section 1 (Goal) to ensure this task's work aligns with the overall objective.

### Step 1: Read the source file

Read `src/lib/i18n.ts` completely to understand exact logic, especially:
- How `getUrlPrefix` handles default vs non-default languages
- How `getLocalizedUrl` builds URLs
- How `stripLangPrefix` handles various path formats
- How `getLangFromUrl` parses paths and falls back to default
- How `getAlternateUrls` generates all language variants

### Step 2: Create `tests/unit/lib/i18n.test.ts`

Write tests organized by function:

#### `getSupportedLanguages`
- Returns an array containing `'en'` and `'es'`
- Returns exactly 2 languages (current config)

#### `getLanguageConfig`
- Returns correct config for `'en'` (name, nativeName, flag, urlPrefix, dateLocale, ogLocale)
- Returns correct config for `'es'` (name, nativeName, flag, urlPrefix, dateLocale, ogLocale)
- Each config has all required fields

#### `getDefaultLanguage`
- Returns `'en'`

#### `isValidLanguage`
- Returns `true` for `'en'`
- Returns `true` for `'es'`
- Returns `false` for `'fr'`
- Returns `false` for `''`
- Returns `false` for `'EN'` (case-sensitive)

#### `isDefaultLanguage`
- Returns `true` for `'en'`
- Returns `false` for `'es'`

#### `getUrlPrefix`
- Returns `''` (empty string) for `'en'` (default language)
- Returns `'/es'` for `'es'`

#### `getDateLocale`
- Returns correct date locale for each language (e.g., `'en-us'` for en, `'es-es'` for es)

#### `getOGLocale`
- Returns correct OG locale for each language (e.g., `'en_US'` for en, `'es_ES'` for es)

#### `getFlag`
- Returns correct flag emoji for each language

#### `getLocalizedUrl`
- Builds correct URL for English (no prefix): `getLocalizedUrl('/about', 'en')` → `'/about'`
- Builds correct URL for Spanish (with prefix): `getLocalizedUrl('/about', 'es')` → `'/es/about'`
- Handles root path: `getLocalizedUrl('/', 'es')` → `'/es'` or `'/es/'`
- Handles paths without leading slash

#### `stripLangPrefix`
- Strips `/es/` prefix: `'/es/about'` → `'/about'`
- Keeps paths without prefix unchanged: `'/about'` → `'/about'`
- Handles root: `'/es'` → `'/'`
- Handles root: `'/es/'` → `'/'`
- Handles default language paths (no stripping needed)

#### `getLangFromUrl`
- Returns `'es'` from `'/es/about'`
- Returns `'en'` from `'/about'` (default fallback)
- Returns `'en'` from `'/'` (root)
- Returns `'es'` from `'/es'` (language root)
- Returns `'es'` from `'/es/'` (language root with trailing slash)

#### `getAlternateUrls`
- Returns array with URLs for all supported languages
- Correct URLs for an English page
- Correct URLs for a Spanish page
- Handles root path

### Step 3: Run tests

```bash
npm run test
```

## 5. Acceptance Criteria

- [ ] `tests/unit/lib/i18n.test.ts` exists with comprehensive tests
- [ ] All 13 exported functions have dedicated `describe` blocks
- [ ] Edge cases covered (root paths, trailing slashes, case sensitivity)
- [ ] All tests pass (`npm run test`)
- [ ] i18n.ts coverage is 95%+

## 6. Outputs

- `tests/unit/lib/i18n.test.ts` — Complete test file for i18n utilities

## 7. Validation

```bash
# Run tests
npm run test

# Run with coverage
npm run test:coverage

# Verify biome compliance
npm run biome:check
```

## 8. Execution Checklist

- [ ] Read `src/lib/i18n.ts` completely
- [ ] Create `tests/unit/lib/i18n.test.ts`
- [ ] Write tests for all 13 exported functions
- [ ] Run `npm run test` — all pass
- [ ] Run `npm run biome:check`
- [ ] Update plan README `[ ] → [x]`
- [ ] Update PROGRESS.md
- [ ] Commit changes
- [ ] Update log below

## 9. Completion & Log

**Status:** Completed

- Tests written: 46
- Tests passing: 46/46
- Coverage for i18n.ts: 100% statements, 100% branches, 100% functions, 100% lines
- Notes: All 13 exported pure functions fully covered with edge cases (case sensitivity, empty strings, root paths, trailing slashes, nested paths)
