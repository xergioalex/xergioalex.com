# Task 8: Write Svelte Component Tests for BlogCard and BlogPagination

## 1. Context

**Purpose:** Create component tests for the two most important interactive Svelte components.

**Where:**
- `tests/unit/components/BlogCard.test.ts` — New test file
- `tests/unit/components/BlogPagination.test.ts` — New test file
- `src/components/blog/BlogCard.svelte` — Source component
- `src/components/blog/BlogPagination.svelte` — Source component

**BlogCard.svelte props:**
```typescript
export let post: CollectionEntry<'blog'>;
export let lang: string = 'en';
export let searchResult: { item: any; score: number; matches?: any[] } | undefined = undefined;
export let isDev: boolean = false;
export let isPreviewMode: boolean = false;
```

**BlogCard key behaviors:**
- Computes post slug from ID (strips lang prefix + date prefix)
- Renders post title, description, hero image, date, tags
- Shows status badges for draft/scheduled/demo posts (when isDev=true)
- Generates correct post URL using language prefix
- Highlights search matches when searchResult is provided

**BlogCard dependencies:**
- `@/lib/i18n` (getUrlPrefix)
- `@/lib/search` (getHighlightedField)
- `@/lib/translations` (getTranslations)
- `./PostStatusBadge.svelte` (child component)

**BlogPagination.svelte props:**
```javascript
export let currentPage = 1;
export let totalPages = 1;
export let isSearchMode = false;
export let onPageChange = null;
export let currentTag = null;
export let lang = 'en';
export let isPreviewMode = false;
```

**BlogPagination key behaviors:**
- Computes visible page numbers with ellipsis logic (max 7 visible pages)
- Handles both search mode (button-based) and navigation mode (link-based)
- Builds tag-aware URLs
- Appends preview query suffix when in preview mode

**Dependencies:** Tasks 1-7 must be completed.

## 2. Read Before Starting

- Task 3 Completion & Log: Verify fixtures are available
- Read both Svelte components fully to understand props, reactive statements, and rendering logic

## 3. Goal

Write component tests using `@testing-library/svelte` for BlogCard and BlogPagination. Focus on rendering behavior, prop variations, and key interactive features. These tests verify the components render correctly with various prop combinations.

## 4. Instructions

> **Before starting:** Re-read the plan README section 1 (Goal) to ensure this task's work aligns with the overall objective.

### Step 1: Read the source components

Read both Svelte components completely:
- `src/components/blog/BlogCard.svelte` — Understand reactive statements, computed values, conditional rendering
- `src/components/blog/BlogPagination.svelte` — Understand pagination logic, URL generation
- `src/components/blog/PostStatusBadge.svelte` — Understand status badge rendering (child of BlogCard)

### Step 2: Create `tests/unit/components/BlogCard.test.ts`

```typescript
import { render, screen } from '@testing-library/svelte';
import BlogCard from '@/components/blog/BlogCard.svelte';
// Import fixtures
```

**Test cases for BlogCard:**

#### Basic rendering
- Renders post title
- Renders post description
- Renders the post date
- Generates correct link URL (English post)
- Generates correct link URL (Spanish post)

#### Hero image
- Renders hero image when `heroImage` is provided
- Does not render image element when `heroImage` is not provided

#### Tags
- Renders tag links when tags are provided
- Does not render tag section when no tags

#### Status badges (when isDev=true)
- Shows draft badge for draft posts
- Shows scheduled badge for scheduled posts
- Shows demo badge for demo posts
- Does not show badges when isDev=false

#### Preview mode
- Appends `?preview=all` to URLs when `isPreviewMode=true`
- Does not append query string when `isPreviewMode=false`

**Note:** If Svelte 5 component testing encounters compatibility issues with `@testing-library/svelte`, document the issue and adjust the approach (e.g., test only the simpler component, or use a different testing approach).

### Step 3: Create `tests/unit/components/BlogPagination.test.ts`

```typescript
import { render, screen } from '@testing-library/svelte';
import BlogPagination from '@/components/blog/BlogPagination.svelte';
```

**Test cases for BlogPagination:**

#### Basic rendering
- Renders page numbers for a simple pagination (e.g., 5 pages)
- Shows current page as active/highlighted
- Does not render when totalPages is 1

#### Ellipsis logic
- Shows ellipsis for many pages (e.g., 20 pages, current=10)
- Shows first and last page numbers always
- Limits visible pages to max 7

#### Previous/Next links
- Previous button disabled on first page
- Next button disabled on last page
- Previous and Next enabled on middle pages

#### URL generation
- Generates correct URLs for page links
- Includes tag in URL when `currentTag` is set
- Appends `?preview=all` when `isPreviewMode=true`

#### Search mode
- Uses buttons instead of links in search mode
- Calls `onPageChange` callback when button clicked

### Step 4: Handle potential Svelte 5 compatibility issues

Svelte 5 changed its component API significantly. If `@testing-library/svelte` does not work with Svelte 5 components:

1. Check if a newer version of `@testing-library/svelte` is needed
2. If needed, install `@testing-library/svelte@next` or latest compatible version
3. If still incompatible, write simpler rendering tests or skip problematic tests with `it.skip()` and document the issue

### Step 5: Run tests

```bash
npm run test
```

## 5. Acceptance Criteria

- [ ] `tests/unit/components/BlogCard.test.ts` exists with component tests
- [ ] `tests/unit/components/BlogPagination.test.ts` exists with component tests
- [ ] Key rendering behaviors tested (title, description, URLs, pagination)
- [ ] Status badge rendering tested
- [ ] All tests pass (`npm run test`)
- [ ] Any Svelte 5 compatibility issues documented

## 6. Outputs

- `tests/unit/components/BlogCard.test.ts` — BlogCard component tests
- `tests/unit/components/BlogPagination.test.ts` — BlogPagination component tests

## 7. Validation

```bash
# Run tests
npm run test

# Verify biome compliance
npm run biome:check
```

## 8. Execution Checklist

- [ ] Read both Svelte components completely
- [ ] Create `tests/unit/components/BlogCard.test.ts`
- [ ] Create `tests/unit/components/BlogPagination.test.ts`
- [ ] Handle any Svelte 5 compatibility issues
- [ ] Run `npm run test` — all pass
- [ ] Run `npm run biome:check`
- [ ] Update plan README `[ ] → [x]`
- [ ] Update PROGRESS.md
- [ ] Commit changes
- [ ] Update log below

## 9. Completion & Log

**Status:** Completed

- BlogCard tests written: 14
- BlogPagination tests written: 17
- Tests passing: 31/31
- Svelte 5 compatibility issues: Svelte 5 requires `resolve.conditions: ['browser']` in vitest config to avoid `lifecycle_function_unavailable` error. The vite-plugin-svelte ignores `compilerOptions.generate` — must use resolve conditions instead.
- Notes: All component tests use @testing-library/svelte render + screen queries. Mock posts from fixtures work with `as never` cast for CollectionEntry type.
