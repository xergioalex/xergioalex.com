# Task 6: Implement Connection Pooling and Reuse

## 1. Context

Optimize external API calls by implementing connection pooling for HTTP clients.

**Location:** `src/common/api/`, `src/functions/botFlow/`

**Dependencies:** Task 5 completed

---

## 2. Goal

Reduce API call overhead by reusing HTTP connections and implementing proper keep-alive.

---

## 3. Instructions

1. **Create HTTP agent with connection pooling:**

   ```typescript
   import { Agent } from 'https'

   const httpAgent = new Agent({
     keepAlive: true,
     keepAliveMsecs: 60000,
     maxSockets: 50,
     maxFreeSockets: 10,
   })
   ```

2. **Configure axios/fetch with agent:**

   ```typescript
   const api = axios.create({
     httpAgent,
     httpsAgent: httpAgent,
     timeout: 5000,
   })
   ```

3. **Implement connection warming:**

   ```typescript
   // Warm connections on cold start
   async function warmConnections() {
     await Promise.all([
       api.get('/health'), // DailyBot API
       // Other critical endpoints
     ])
   }
   ```

4. **Add retry logic with exponential backoff:**

   ```typescript
   async function retryRequest(fn: () => Promise<any>, maxRetries = 3) {
     for (let i = 0; i < maxRetries; i++) {
       try {
         return await fn()
       } catch (error) {
         if (i === maxRetries - 1) throw error
         await sleep(Math.pow(2, i) * 1000)
       }
     }
   }
   ```

5. **Parallelize independent API calls:**

   ```typescript
   // Before: sequential
   const user = await api.getUser(userId)
   const org = await api.getOrg(orgId)

   // After: parallel
   const [user, org] = await Promise.all([api.getUser(userId), api.getOrg(orgId)])
   ```

---

## 4. Acceptance Criteria

- [ ] HTTP agent with connection pooling created
- [ ] All API clients configured with agent
- [ ] Connection warming implemented
- [ ] Retry logic with exponential backoff added
- [ ] Independent API calls parallelized
- [ ] API call time reduced by 30%
- [ ] No increase in error rates

---

## 5. Validation

```bash
npm run test
npm run sls:deploy:dev
# Check API latencies in X-Ray
codecheck
```

---

## 6. Completion & Log

**Status:** Not started
