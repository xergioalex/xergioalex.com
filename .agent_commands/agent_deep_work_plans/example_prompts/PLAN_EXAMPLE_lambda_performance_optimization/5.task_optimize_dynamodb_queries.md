# Task 5: Optimize DynamoDB Queries and Implement Caching

## 1. Context

Based on Task 2 profiling, optimize DynamoDB queries identified as bottlenecks.

**Location:** `src/common/engine/storage/`, `src/functions/botFlow/`

**Dependencies:** Task 2 completed (profiling identified slow queries)

---

## 2. Goal

Reduce DynamoDB query time by 50% through batching, caching, and query optimization.

---

## 3. Instructions

1. **Implement batch operations:**

   ```typescript
   // Replace sequential GetItem calls with BatchGetItem
   const items = await dynamodb.batchGet({
     RequestItems: {
       [tableName]: {
         Keys: keys,
       },
     },
   })
   ```

2. **Add query result caching:**

   ```typescript
   // Simple in-memory cache for frequently accessed data
   const cache = new Map<string, CachedItem>()

   async function getCachedItem(key: string) {
     if (cache.has(key) && !isExpired(cache.get(key))) {
       return cache.get(key).data
     }
     const item = await dynamodb.get(key)
     cache.set(key, { data: item, expiry: Date.now() + 60000 })
     return item
   }
   ```

3. **Optimize query patterns:**
   - Use GSI for secondary access patterns
   - Reduce over-fetching (ProjectionExpression)
   - Implement consistent read only when needed

4. **Implement connection reuse:**

   ```typescript
   // Create DynamoDB client once, outside handler
   let dynamodbClient: DynamoDBClient

   function getDynamoDBClient() {
     if (!dynamodbClient) {
       dynamodbClient = new DynamoDBClient({
         region: process.env.AWS_REGION,
         maxAttempts: 3,
       })
     }
     return dynamodbClient
   }
   ```

5. **Add performance logging:**
   ```typescript
   Logger.startLogExecutionTime('dynamodb_query', 'DynamoDB Query', 'storage')
   const result = await dynamodb.query(params)
   Logger.endLogExecutionTime('dynamodb_query')
   ```

---

## 4. Acceptance Criteria

- [ ] Batch operations implemented for sequential queries
- [ ] In-memory caching added for frequently accessed data
- [ ] Query patterns optimized (GSI, ProjectionExpression)
- [ ] DynamoDB client connection reused
- [ ] Performance logging added
- [ ] Average query time reduced by 50%
- [ ] All tests passing

---

## 5. Validation

```bash
npm run test
# Check DynamoDB metrics in CloudWatch after deployment
npm run sls:deploy:dev
# Run X-Ray profiling again to verify improvement
codecheck
```

---

## 6. Completion & Log

**Status:** Not started
