# Task 8: Add Performance Monitoring and Metrics

## 1. Context

Implement comprehensive performance monitoring to track improvements and detect regressions.

**Location:** `src/common/logger.ts`, `src/functions/botFlow/`, CloudWatch

**Dependencies:** Tasks 1-7 completed

---

## 2. Goal

Add custom CloudWatch metrics and monitoring to track performance in production.

---

## 3. Instructions

1. **Add custom CloudWatch metrics:**

   ```typescript
   import { CloudWatch } from 'aws-sdk'

   const cloudwatch = new CloudWatch()

   async function publishMetric(name: string, value: number, unit: string) {
     await cloudwatch
       .putMetricData({
         Namespace: 'DailyBot/Performance',
         MetricData: [
           {
             MetricName: name,
             Value: value,
             Unit: unit,
             Timestamp: new Date(),
           },
         ],
       })
       .promise()
   }
   ```

2. **Track cold start metrics:**

   ```typescript
   let isColdStart = true

   export const handler = async (event: any) => {
     const startTime = Date.now()

     if (isColdStart) {
       await publishMetric('ColdStart', 1, 'Count')
       isColdStart = false
     }

     // ... handler logic

     const duration = Date.now() - startTime
     await publishMetric('ExecutionTime', duration, 'Milliseconds')
   }
   ```

3. **Track DynamoDB query performance:**

   ```typescript
   async function queryWithMetrics(params: any) {
     const start = Date.now()
     const result = await dynamodb.query(params)
     await publishMetric('DynamoDBQueryTime', Date.now() - start, 'Milliseconds')
     return result
   }
   ```

4. **Create CloudWatch Dashboard:**

   ```yaml
   # Add to serverless.yml
   resources:
     Resources:
       PerformanceDashboard:
         Type: AWS::CloudWatch::Dashboard
         Properties:
           DashboardName: botFlow-performance
           DashboardBody: |
             {
               "widgets": [
                 {
                   "type": "metric",
                   "properties": {
                     "metrics": [
                       ["DailyBot/Performance", "ColdStart"],
                       [".", "ExecutionTime"],
                       [".", "DynamoDBQueryTime"]
                     ],
                     "period": 300,
                     "stat": "Average",
                     "region": "${aws:region}",
                     "title": "botFlow Performance"
                   }
                 }
               ]
             }
   ```

5. **Set up CloudWatch alarms:**

   ```yaml
   ColdStartAlarm:
     Type: AWS::CloudWatch::Alarm
     Properties:
       AlarmName: botFlow-high-cold-starts
       MetricName: ColdStart
       Namespace: DailyBot/Performance
       Statistic: Sum
       Period: 300
       EvaluationPeriods: 2
       Threshold: 10
       ComparisonOperator: GreaterThanThreshold

   ExecutionTimeAlarm:
     Type: AWS::CloudWatch::Alarm
     Properties:
       AlarmName: botFlow-slow-execution
       MetricName: ExecutionTime
       Namespace: DailyBot/Performance
       Statistic: Average
       Period: 300
       EvaluationPeriods: 2
       Threshold: 1000 # 1 second
       ComparisonOperator: GreaterThanThreshold
   ```

6. **Add performance logging:**
   ```typescript
   Logger.log('Performance metrics', {
     coldStart: isColdStart,
     executionTime: duration,
     memoryUsed: process.memoryUsage().heapUsed / 1024 / 1024,
     platform: event.platform,
   })
   ```

---

## 4. Acceptance Criteria

- [ ] Custom CloudWatch metrics published
- [ ] Cold start tracking implemented
- [ ] Execution time tracking added
- [ ] DynamoDB query time tracked
- [ ] CloudWatch dashboard created
- [ ] CloudWatch alarms configured
- [ ] Performance logging added
- [ ] All metrics visible in CloudWatch

---

## 5. Validation

```bash
npm run test
npm run sls:deploy:dev

# Invoke function and check metrics
aws cloudwatch get-metric-statistics \
  --namespace DailyBot/Performance \
  --metric-name ColdStart \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum

# Check dashboard exists
aws cloudwatch list-dashboards | grep botFlow-performance

codecheck
```

---

## 6. Completion & Log

**Status:** Not started
